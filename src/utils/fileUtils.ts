/**
 * Êñá‰ª∂ÁÆ°ÁêÜÂ∑•ÂÖ∑ÂáΩÊï∞
 * 
 * Êèê‰æõÊñá‰ª∂Êìç‰ΩúÁõ∏ÂÖ≥ÁöÑÂ∑•ÂÖ∑ÂáΩÊï∞
 */

import type {
  FileListItem,
  FileSortConfig,
  FileFilterConfig,
  FilePreview,
} from '../types/fileManager';

/**
 * Êñá‰ª∂Â§ßÂ∞èÊ†ºÂºèÂåñ
 */
export function formatFileSize(bytes: number): string {
  if (bytes === 0) return '0 B';
  
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

/**
 * Ëé∑ÂèñÊñá‰ª∂Á±ªÂûã‰ø°ÊÅØ
 */
export function getFileTypeInfo(filename: string): {
  type: string;
  category: 'image' | 'document' | 'archive' | 'video' | 'audio' | 'code' | 'other';
  icon: string;
  color: string;
} {
  const extension = filename.split('.').pop()?.toLowerCase() || '';
  
  // ÂõæÁâáÊñá‰ª∂
  if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg', 'ico'].includes(extension)) {
    return {
      type: extension.toUpperCase(),
      category: 'image',
      icon: 'üñºÔ∏è',
      color: '#4CAF50',
    };
  }
  
  // ÊñáÊ°£Êñá‰ª∂
  if (['pdf', 'doc', 'docx', 'txt', 'md', 'rtf', 'odt'].includes(extension)) {
    return {
      type: extension.toUpperCase(),
      category: 'document',
      icon: 'üìÑ',
      color: '#2196F3',
    };
  }
  
  // ÂéãÁº©Êñá‰ª∂
  if (['zip', 'rar', '7z', 'tar', 'gz', 'bz2'].includes(extension)) {
    return {
      type: extension.toUpperCase(),
      category: 'archive',
      icon: 'üì¶',
      color: '#FF9800',
    };
  }
  
  // ËßÜÈ¢ëÊñá‰ª∂
  if (['mp4', 'avi', 'mkv', 'mov', 'wmv', 'flv', 'webm'].includes(extension)) {
    return {
      type: extension.toUpperCase(),
      category: 'video',
      icon: 'üé¨',
      color: '#E91E63',
    };
  }
  
  // Èü≥È¢ëÊñá‰ª∂
  if (['mp3', 'wav', 'flac', 'aac', 'ogg', 'wma'].includes(extension)) {
    return {
      type: extension.toUpperCase(),
      category: 'audio',
      icon: 'üéµ',
      color: '#9C27B0',
    };
  }
  
  // ‰ª£Á†ÅÊñá‰ª∂
  if (['js', 'ts', 'jsx', 'tsx', 'html', 'css', 'scss', 'json', 'xml', 'py', 'java', 'cpp', 'c', 'rs', 'go'].includes(extension)) {
    return {
      type: extension.toUpperCase(),
      category: 'code',
      icon: 'üíª',
      color: '#607D8B',
    };
  }
  
  // ÂÖ∂‰ªñÊñá‰ª∂
  return {
    type: extension.toUpperCase() || 'FILE',
    category: 'other',
    icon: 'üìÅ',
    color: '#757575',
  };
}

/**
 * Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶‰∏∫ÂõæÁâá
 */
export function isImageFile(filename: string): boolean {
  const { category } = getFileTypeInfo(filename);
  return category === 'image';
}

/**
 * ÁîüÊàêÊñá‰ª∂È¢ÑËßà URL
 */
export function generatePreviewUrl(file: FileListItem): string | null {
  if (!isImageFile(file.name)) {
    return null;
  }
  
  // ËøôÈáåÂ∫îËØ•Ê†πÊçÆÂÆûÈôÖÁöÑÊñá‰ª∂Â≠òÂÇ®ÊñπÂºèÁîüÊàêÈ¢ÑËßà URL
  // ÊöÇÊó∂ËøîÂõû‰∏Ä‰∏™Âç†‰ΩçÁ¨¶
  return `/api/files/${file.id}/preview`;
}

/**
 * Êñá‰ª∂ÊéíÂ∫èÂáΩÊï∞
 */
export function sortFiles(files: FileListItem[], sortConfig: FileSortConfig): FileListItem[] {
  const { field, direction } = sortConfig;
  
  return [...files].sort((a, b) => {
    let aValue: any;
    let bValue: any;
    
    switch (field) {
      case 'name':
        aValue = a.name.toLowerCase();
        bValue = b.name.toLowerCase();
        break;
      case 'size':
        aValue = a.file_size;
        bValue = b.file_size;
        break;
      case 'modified':
        aValue = new Date(a.updated_at).getTime();
        bValue = new Date(b.updated_at).getTime();
        break;
      case 'type':
        aValue = getFileTypeInfo(a.name).type;
        bValue = getFileTypeInfo(b.name).type;
        break;
      default:
        return 0;
    }
    
    if (aValue < bValue) {
      return direction === 'asc' ? -1 : 1;
    }
    if (aValue > bValue) {
      return direction === 'asc' ? 1 : -1;
    }
    return 0;
  });
}

/**
 * Êñá‰ª∂ËøáÊª§ÂáΩÊï∞
 */
export function filterFiles(files: FileListItem[], filterConfig: FileFilterConfig): FileListItem[] {
  let filteredFiles = files;
  
  // ÊåâÊñá‰ª∂Á±ªÂûãËøáÊª§
  if (filterConfig.fileTypes && filterConfig.fileTypes.length > 0) {
    filteredFiles = filteredFiles.filter(file => {
      const { category } = getFileTypeInfo(file.name);
      return filterConfig.fileTypes!.includes(category);
    });
  }
  
  // ÊåâÊñá‰ª∂Â§ßÂ∞èËøáÊª§
  if (filterConfig.minSize !== undefined) {
    filteredFiles = filteredFiles.filter(file => file.file_size >= filterConfig.minSize!);
  }
  
  if (filterConfig.maxSize !== undefined) {
    filteredFiles = filteredFiles.filter(file => file.file_size <= filterConfig.maxSize!);
  }
  
  // Êåâ‰øÆÊîπÊó∂Èó¥ËøáÊª§
  if (filterConfig.dateRange) {
    const { start, end } = filterConfig.dateRange;
    filteredFiles = filteredFiles.filter(file => {
      const fileDate = new Date(file.updated_at);
      return fileDate >= start && fileDate <= end;
    });
  }
  
  // ÊåâÊêúÁ¥¢ÂÖ≥ÈîÆËØçËøáÊª§
  if (filterConfig.searchQuery) {
    const query = filterConfig.searchQuery.toLowerCase();
    filteredFiles = filteredFiles.filter(file => 
      file.name.toLowerCase().includes(query)
    );
  }
  
  return filteredFiles;
}

/**
 * Ê†ºÂºèÂåñÊó•Êúü
 */
export function formatDate(date: string | Date): string {
  const d = new Date(date);
  const now = new Date();
  const diffMs = now.getTime() - d.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) {
    return '‰ªäÂ§© ' + d.toLocaleTimeString('zh-CN', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  } else if (diffDays === 1) {
    return 'Êò®Â§© ' + d.toLocaleTimeString('zh-CN', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  } else if (diffDays < 7) {
    return `${diffDays}Â§©Ââç`;
  } else {
    return d.toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
    });
  }
}

/**
 * ÁîüÊàêÂîØ‰∏Ä ID
 */
export function generateId(): string {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

/**
 * È™åËØÅÊñá‰ª∂Âêç
 */
export function validateFileName(name: string): { valid: boolean; error?: string } {
  if (!name || name.trim().length === 0) {
    return { valid: false, error: 'Êñá‰ª∂Âêç‰∏çËÉΩ‰∏∫Á©∫' };
  }
  
  if (name.length > 255) {
    return { valid: false, error: 'Êñá‰ª∂ÂêçËøáÈïøÔºàÊúÄÂ§ß255Â≠óÁ¨¶Ôºâ' };
  }
  
  // Ê£ÄÊü•ÈùûÊ≥ïÂ≠óÁ¨¶
  const invalidChars = /[<>:"/\\|?*]/;
  if (invalidChars.test(name)) {
    return { valid: false, error: 'Êñá‰ª∂ÂêçÂåÖÂê´ÈùûÊ≥ïÂ≠óÁ¨¶' };
  }
  
  // Ê£ÄÊü•‰øùÁïôÂêçÁß∞
  const reservedNames = [
    'CON', 'PRN', 'AUX', 'NUL',
    'COM1', 'COM2', 'COM3', 'COM4', 'COM5', 'COM6', 'COM7', 'COM8', 'COM9',
    'LPT1', 'LPT2', 'LPT3', 'LPT4', 'LPT5', 'LPT6', 'LPT7', 'LPT8', 'LPT9'
  ];
  
  const nameWithoutExt = name.split('.')[0].toUpperCase();
  if (reservedNames.includes(nameWithoutExt)) {
    return { valid: false, error: 'Êñá‰ª∂Âêç‰∏∫Á≥ªÁªü‰øùÁïôÂêçÁß∞' };
  }
  
  return { valid: true };
}

/**
 * È™åËØÅÁõÆÂΩïÂêç
 */
export function validateDirectoryName(name: string): { valid: boolean; error?: string } {
  const result = validateFileName(name);
  
  if (!result.valid) {
    return result;
  }
  
  // ÁõÆÂΩïÂêç‰∏çËÉΩÂåÖÂê´Êâ©Â±ïÂêç
  if (name.includes('.')) {
    return { valid: false, error: 'ÁõÆÂΩïÂêç‰∏çËÉΩÂåÖÂê´Êâ©Â±ïÂêç' };
  }
  
  return { valid: true };
}

/**
 * Ëé∑ÂèñÊñá‰ª∂Êâ©Â±ïÂêç
 */
export function getFileExtension(filename: string): string {
  const parts = filename.split('.');
  return parts.length > 1 ? parts.pop()!.toLowerCase() : '';
}

/**
 * Ëé∑ÂèñÊñá‰ª∂ÂêçÔºà‰∏çÂê´Êâ©Â±ïÂêçÔºâ
 */
export function getFileNameWithoutExtension(filename: string): string {
  const parts = filename.split('.');
  return parts.length > 1 ? parts.slice(0, -1).join('.') : filename;
}

/**
 * Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶ÂèØ‰ª•È¢ÑËßà
 */
export function canPreviewFile(filename: string): boolean {
  const { category } = getFileTypeInfo(filename);
  return ['image', 'document'].includes(category);
}

/**
 * ÁîüÊàêÊñá‰ª∂Áº©Áï•Âõæ URL
 */
export function generateThumbnailUrl(file: FileListItem, size: number = 150): string | null {
  if (!isImageFile(file.name)) {
    return null;
  }
  
  return `/api/files/${file.id}/thumbnail?size=${size}`;
}

/**
 * ËÆ°ÁÆóÊñá‰ª∂‰∏ä‰º†ËøõÂ∫¶
 */
export function calculateUploadProgress(loaded: number, total: number): number {
  if (total === 0) return 0;
  return Math.round((loaded / total) * 100);
}

/**
 * Ê†ºÂºèÂåñ‰∏ä‰º†ÈÄüÂ∫¶
 */
export function formatUploadSpeed(bytesPerSecond: number): string {
  return formatFileSize(bytesPerSecond) + '/s';
}

/**
 * ‰º∞ÁÆóÂâ©‰Ωô‰∏ä‰º†Êó∂Èó¥
 */
export function estimateRemainingTime(loaded: number, total: number, speed: number): string {
  if (speed === 0 || loaded >= total) return '0Áßí';
  
  const remaining = (total - loaded) / speed;
  
  if (remaining < 60) {
    return `${Math.ceil(remaining)}Áßí`;
  } else if (remaining < 3600) {
    return `${Math.ceil(remaining / 60)}ÂàÜÈíü`;
  } else {
    return `${Math.ceil(remaining / 3600)}Â∞èÊó∂`;
  }
}

/**
 * Ê£ÄÊü•ÊãñÊãΩÊï∞ÊçÆÊòØÂê¶ÂåÖÂê´Êñá‰ª∂
 */
export function hasFiles(dataTransfer: DataTransfer): boolean {
  return Array.from(dataTransfer.types).includes('Files');
}

/**
 * ‰ªéÊãñÊãΩ‰∫ã‰ª∂‰∏≠ÊèêÂèñÊñá‰ª∂
 */
export function getFilesFromDragEvent(event: React.DragEvent | DragEvent): File[] {
  const files: File[] = [];
  
  if (event.dataTransfer?.files) {
    Array.from(event.dataTransfer.files).forEach(file => {
      files.push(file);
    });
  }
  
  return files;
}

/**
 * ÂàõÂª∫Êñá‰ª∂È¢ÑËßàÂØπË±°
 */
export function createFilePreview(file: File): FilePreview {
  const fileTypeInfo = getFileTypeInfo(file.name);
  return {
    id: generateId(),
    name: file.name,
    size: file.size,
    type: file.type,
    lastModified: file.lastModified,
    preview: isImageFile(file.name) ? URL.createObjectURL(file) : undefined,
    isImage: fileTypeInfo.category === 'image',
    isVideo: fileTypeInfo.category === 'video',
    isDocument: fileTypeInfo.category === 'document',
  };
}

/**
 * Ê∏ÖÁêÜÊñá‰ª∂È¢ÑËßà URL
 */
export function revokeFilePreview(preview: FilePreview): void {
  if (preview.preview) {
    URL.revokeObjectURL(preview.preview);
  }
}

/**
 * ÊâπÈáèÊ∏ÖÁêÜÊñá‰ª∂È¢ÑËßà URL
 */
export function revokeFilePreviews(previews: FilePreview[]): void {
  previews.forEach(revokeFilePreview);
}

/**
 * Ê∑±Â∫¶ÂÖãÈöÜÂØπË±°
 */
export function deepClone<T>(obj: T): T {
  if (obj === null || typeof obj !== 'object') {
    return obj;
  }
  
  if (obj instanceof Date) {
    return new Date(obj.getTime()) as unknown as T;
  }
  
  if (obj instanceof Array) {
    return obj.map(item => deepClone(item)) as unknown as T;
  }
  
  if (typeof obj === 'object') {
    const cloned = {} as T;
    Object.keys(obj).forEach(key => {
      (cloned as any)[key] = deepClone((obj as any)[key]);
    });
    return cloned;
  }
  
  return obj;
}

/**
 * Èò≤ÊäñÂáΩÊï∞
 */
export function debounce<T extends (...args: any[]) => any>(
  func: T,
  wait: number
): (...args: Parameters<T>) => void {
  let timeout: NodeJS.Timeout;
  
  return (...args: Parameters<T>) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => func(...args), wait);
  };
}

/**
 * ËäÇÊµÅÂáΩÊï∞
 */
export function throttle<T extends (...args: any[]) => any>(
  func: T,
  wait: number
): (...args: Parameters<T>) => void {
  let inThrottle: boolean;
  
  return (...args: Parameters<T>) => {
    if (!inThrottle) {
      func(...args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, wait);
    }
  };
}